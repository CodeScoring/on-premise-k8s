apiVersion: batch/v1
kind: Job
metadata:
  name: ipcs-migrations
spec:
  ttlSecondsAfterFinished: 300
  template:
    spec:
      volumes:
        - name: analysis-root
          persistentVolumeClaim:
            claimName: analysis-root-pvc
      containers:
        - name: ipcs-migrate
          image: registry-one.codescoring.ru/ipcs-backend
          command: ['python', 'manage.py', 'migrate']
          envFrom:
          - configMapRef:
              name: ipcs-env
          - secretRef:
              name: ipcs-secrets
          volumeMounts:
            - name: analysis-root
              mountPath: /analysis-root
          imagePullPolicy: Always
      imagePullSecrets:
        - name: cs-registry
      restartPolicy: OnFailure
  backoffLimit: 5
---
apiVersion: batch/v1
kind: Job
metadata:
  name: ipcs-collectstatic
spec:
  ttlSecondsAfterFinished: 300
  template:
    spec:
      volumes:
        - name: django-static
          persistentVolumeClaim:
            claimName: django-static-pvc
      containers:
        - name: ipcs-collectstatic
          image: registry-one.codescoring.ru/ipcs-backend
          command: ['python', 'manage.py', 'collectstatic']
          envFrom:
          - configMapRef:
              name: ipcs-env
          - secretRef:
              name: ipcs-secrets
          imagePullPolicy: Always
          volumeMounts:
            - name: django-static
              mountPath: /ipcs-backend/static
      imagePullSecrets:
        - name: cs-registry
      restartPolicy: OnFailure
  backoffLimit: 5

